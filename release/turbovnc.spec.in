# Path under which TurboVNC should be installed
%define prefix @CMAKE_INSTALL_PREFIX@

# Path under which executables should be installed
%define bindir @TVNC_BINDIR@

# Path under which configuration files should be installed
%define confdir @TVNC_CONFDIR@

# Path under which docs should be installed
%define docdir @TVNC_DOCDIR@

# Path under which man pages should be installed
%define mandir @TVNC_MANDIR@

# Whether or not to include Java viewer
%define java @BUILD_JAVA@

# Path under which Java viewer should be installed
%define javadir @TVNC_JAVADIR@

Summary:   A highly-optimized version of VNC that can be used with performance-critical applications
Name:      @CMAKE_PROJECT_NAME_LC@
Version:   @VERSION@
Release:   @BUILD@
URL:       http://www.virtualgl.org
#-->Source0: http://prdownloads.sourceforge.net/virtualgl/%{name}-%{version}.tar.gz
License:   GPL
Group:     User Interface/Desktops
Requires:  bash >= 2.0
Prereq:    /sbin/chkconfig %{_sysconfdir}/init.d
BuildRoot: %{_blddir}/%{name}-%{version}-root
BuildPrereq: /usr/bin/perl libjpeg-turbo
BuildRequires: zlib-devel

%description
Virtual Network Computing (VNC) is a remote display system that allows you to
view and interact with a desktop environment that is running on a remote
computer.  Using VNC, you can run graphical applications on a remote machine
and send only the pixels generated by these applications to your local machine.
VNC is platform-independent and supports a wide variety of operating systems
and architectures as both servers and clients.

TurboVNC is a high-speed version of VNC derived from TightVNC.  It contains
a variant of Tight encoding that is tuned to maximize performance for image-
intensive applications (such as VirtualGL, video applications, and image
editors) while still providing excellent performance for other types of
applications.  TurboVNC, in combination with VirtualGL, provides a complete
solution for remotely displaying 3D applications with interactive performance.

#-->%prep
#-->%setup -q

#-->%build
#-->cmake -G"Unix Makefiles" -DCMAKE_INSTALL_PREFIX=%{prefix} -DTVNC_BINDIR=%{bindir} -DTVNC_CONFDIR=%{confdir} -DTVNC_DOCDIR=%{docdir} -DTVNC_MANDIR=%{mandir} -DCMAKE_BUILD_TYPE=@CMAKE_BUILD_TYPE@ -DCMAKE_VERBOSE_MAKEFILE=@CMAKE_VERBOSE_MAKEFILE@ .
#-->make
#-->make xserver

%install
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
make xserver-install DESTDIR=$RPM_BUILD_ROOT

mkdir -p $RPM_BUILD_ROOT%{_defaultdocdir}
if [ ! "%{docdir}" = "%{_defaultdocdir}/%{name}-%{version}" ]; then
  mv $RPM_BUILD_ROOT/%{docdir} $RPM_BUILD_ROOT/__tmpdoc
  mkdir -p $RPM_BUILD_ROOT%{_defaultdocdir}
  mv $RPM_BUILD_ROOT/__tmpdoc $RPM_BUILD_ROOT%{_defaultdocdir}/%{name}-%{version}
fi
if [ ! "%{confdir}" = "%{_sysconfdir}" ]; then
  mv $RPM_BUILD_ROOT/%{confdir} $RPM_BUILD_ROOT/__tmpconf
  mv $RPM_BUILD_ROOT/__tmpconf $RPM_BUILD_ROOT%{_sysconfdir}
fi



mkdir -p %{buildroot}/usr/share/applications
cat > %{buildroot}/usr/share/applications/tvncviewer.desktop << EOF
[Desktop Entry]
Name=TurboVNC Viewer
Comment=TurboVNC client application
Exec=@prefix@/bin/vncviewer
Terminal=0
Type=Application
Categories=Application;Utility;X-Red-Hat-Extra;
EOF

%clean
rm -rf %{buildroot}

%post
if [ "$1" = 1 ]; then
  if [ -f /etc/redhat-release ]; then /sbin/chkconfig --add tvncserver; fi
fi

%preun
if [ "$1" = 0 ]; then
  /etc/init.d/tvncserver stop >/dev/null 2>&1
  if [ -f /etc/redhat-release ]; then /sbin/chkconfig --del tvncserver; fi
fi

%postun
if [ "$1" -ge "1" ]; then
  /etc/init.d/tvncserver condrestart >/dev/null 2>&1
fi

%files
%defattr(-,root,root)
%attr(0755,root,root) %config %{_sysconfdir}/init.d/tvncserver
%config(noreplace) %{_sysconfdir}/sysconfig/tvncservers
%config(noreplace) %{_sysconfdir}/turbovncserver.conf
%config(noreplace) %{_sysconfdir}/turbovncserver-auth.conf

%dir %{_defaultdocdir}/%{name}-%{version}
%doc %{_defaultdocdir}/%{name}-%{version}/*

%dir %{prefix}
%dir %{bindir}
%dir %{mandir}
%dir %{mandir}/man1
%if "%{java}" == "ON"
 %dir %{javadir}
%endif

%{bindir}/vncviewer
%config(noreplace) /usr/share/applications/tvncviewer.desktop
%{mandir}/man1/vncviewer.1*
%{bindir}/Xvnc
%{bindir}/tvncconfig
%{bindir}/vncserver
%{bindir}/vncpasswd
%{bindir}/vncconnect
%if "%{java}" == "ON"
 %{javadir}/index.vnc
 %{javadir}/VncViewer.jar
 %{javadir}/README
%endif
%{mandir}/man1/Xvnc.1*
%{mandir}/man1/Xserver.1*
%{mandir}/man1/vncserver.1*
%{mandir}/man1/vncconnect.1*
%{mandir}/man1/vncpasswd.1*

%changelog
