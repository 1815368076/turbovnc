#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

TMPDIR=

onexit()
{
	if [ ! "$TMPDIR" = "" ]; then
		rm -rf $TMPDIR
	fi
}

SRCDIR=@CMAKE_SOURCE_DIR@
JAR=@Java_JAR_EXECUTABLE@
JAVAC=@Java_JAVAC_EXECUTABLE@
JDEPS=`dirname "$JAR"`/jdeps
JLINK=`dirname "$JAR"`/jlink
JMODS=`dirname "$JAR"`/../jmods
JVERSION=@Java_VERSION_MAJOR@

SUFFIX=

umask 022
TMPDIR=`mktemp -d /tmp/makemacapp.XXXXXX`
APP="@CMAKE_PROJECT_NAME@ Viewer$SUFFIX.app"

if [ -d "$APP" ]; then
	rm -rf "$APP"
fi

mkdir -p "$APP/Contents/MacOS"
mkdir -p "$APP/Contents/Resources/Java"
mkdir -p "$APP/Contents/Resources/Native"

$JDEPS --generate-module-info $TMPDIR java/VncViewer.jar
cp java/VncViewer.jar $TMPDIR
$JAVAC --patch-module VncViewer=$TMPDIR/VncViewer.jar $TMPDIR/VncViewer/module-info.java
$JAR uf $TMPDIR/VncViewer.jar -C $TMPDIR/VncViewer module-info.class
$JLINK -p $TMPDIR/VncViewer.jar:$JMODS --add-modules VncViewer --limit-modules VncViewer --output "$APP/Contents/PlugIns/jre/Contents/Home" --ignore-signing-information

cp pkgscripts/Info.plist "$APP/Contents/Info.plist"
cp bin/JavaAppLauncher "$APP/Contents/MacOS/@CMAKE_PROJECT_NAME@ Viewer"
echo "APPL????" >"$APP/Contents/PkgInfo"
cp java/VncViewer.jar "$APP/Contents/Resources/Java/"
cp $SRCDIR/java/com/turbovnc/vncviewer/README.txt "$APP/Contents/Resources/Java/"
cp $SRCDIR/LICENSE.txt "$APP/Contents/Resources/Java/"
cp $SRCDIR/release/turbovnc.icns "$APP/Contents/Resources/"
cp $SRCDIR/release/vncviewer.icns "$APP/Contents/Resources/"
cp @TJPEG_JNILIBRARY@ "$APP/Contents/Resources/Native/"
cp @TJPEG_JNILIBRARY@ "$APP/Contents/Resources/Native/"
cp java/libturbovnchelper.dylib "$APP/Contents/Resources/Native/"

exit
