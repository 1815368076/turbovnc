#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

pkgtmpdir=

onexit()
{
	if [ ! "$pkgtmpdir" = "" ]; then
		rm -rf $pkgtmpdir
	fi
}

usage()
{
	echo "$0 <version> <build> <package architecture> <source dir.> [medialib]"
	exit 1
}

MEDIALIB=0

if [ $# -lt 4 ]; then usage $0; fi
pkgname=TurboVNC
VERSION=$1
BUILD=$2
PKGARCH=$3
SRCDIR=$4
if [ $# -gt 4 ]; then
	if [ "$5" = "medialib" ]; then 
		MEDIALIB=1
	fi
fi

umask 022
pkgtmpdir=`mktemp -d /tmp/$pkgname-build.XXXXXX`
PKGROOT=$pkgtmpdir/pkgbuild/$pkgname
mkdir -p $PKGROOT
touch $pkgtmpdir/depend

cat > $pkgtmpdir/copyright <<EOF 
Use is subject to the terms of the GNU General Public License, Version 2
EOF

cat > $pkgtmpdir/depend <<EOF 
P SUNWcar       Core Architecture, (Root)
P SUNWkvm       Core Architecture, (Kvm)
P SUNWcsr       Core Solaris, (Root)
P SUNWcsu       Core Solaris, (Usr)
P SUNWxwplt     X Windows platform software
EOF

if [ $MEDIALIB ]; then
cat >> $pkgtmpdir/depend <<EOF 
P SUNWmlib      mediaLib - Shared Libraries
EOF
fi

if [ ! "$PKGARCH" = "sparc" ]; then
	PKGARCH=i386
fi

cat > $pkgtmpdir/pkginfo <<EOF 
ARCH=$PKGARCH
PKG=$pkgname
NAME=TurboVNC server and client
VERSION=$VERSION,REV=$BUILD
SUNW_PKGVERS=1.0
DESC=TurboVNC is a sleek and fast VNC distribution, containing a high-performance implementation of tight encoding designed to work in conjunction with VirtualGL.
VENDOR=The VirtualGL Project
HOTLINE=http://www.VirtualGL.org
EMAIL=information@virtualgl.org
MAXINST=1
CATEGORY=application
BASEDIR=/opt
CLASSES=none
EOF

cat > $pkgtmpdir/proto <<EOF
i copyright
i depend
i pkginfo
d none $pkgname 0755 root bin
d none $pkgname/bin 0755 root bin
f none $pkgname/bin/vncpasswd 0755 root bin
f none $pkgname/bin/vncviewer 0755 root bin
f none $pkgname/bin/vncserver 0755 root bin
f none $pkgname/bin/vncconnect 0755 root bin
f none $pkgname/bin/Xvnc 0755 root bin
f none $pkgname/bin/autocutsel 0755 root bin
d none $pkgname/doc 0755 root bin
f none $pkgname/doc/LICENCE.TXT 0644 root bin
f none $pkgname/doc/TurboVNC-ChangeLog.txt 0644 root bin
EOF
for i in $SRCDIR/../vnc_docs/*.png; do echo f none $pkgname/doc/`basename $i` 0644 root bin >> $pkgtmpdir/proto; done
echo f none $pkgname/doc/index.html 0644 root bin >> $pkgtmpdir/proto
for i in $SRCDIR/../vnc_docs/*.css; do echo f none $pkgname/doc/`basename $i` 0644 root bin >> $pkgtmpdir/proto; done
for i in $SRCDIR/../vnc_docs/LICEN*.txt; do echo f none $pkgname/doc/`basename $i` 0644 root bin >> $pkgtmpdir/proto; done
cat >> $pkgtmpdir/proto <<EOF
d none $pkgname/man 0755 root bin
d none $pkgname/man/man1 0755 root bin
f none $pkgname/man/man1/vncpasswd.1 0644 root bin
f none $pkgname/man/man1/vncviewer.1 0644 root bin
f none $pkgname/man/man1/vncserver.1 0644 root bin
f none $pkgname/man/man1/vncconnect.1 0644 root bin
f none $pkgname/man/man1/Xvnc.1 0644 root bin
f none $pkgname/man/man1/Xserver.1 0644 root bin
d none $pkgname/vnc 0755 root bin
d none $pkgname/vnc/classes 0755 root bin
f none $pkgname/vnc/classes/VncViewer.jar 0644 root bin
f none $pkgname/vnc/classes/index.vnc 0644 root bin
f none $pkgname/vnc/classes/README 0644 root bin
d none $pkgname/etc 0755 root bin
f none $pkgname/etc/turbovncserver.conf 0644 root bin
f none $pkgname/etc/turbovncserver-auth.conf 0644 root bin
EOF

make install DESTDIR=$pkgtmpdir
make xserver-install DESTDIR=$pkgtmpdir
mkdir -p $pkgtmpdir/opt/$pkgname/doc
cp $SRCDIR/../vnc_docs/*.png $SRCDIR/../vnc_docs/*.css $SRCDIR/../vnc_docs/index.html $SRCDIR/../vnc_docs/LICEN*.txt LICENCE.TXT $SRCDIR/../TurboVNC-ChangeLog.txt $pkgtmpdir/opt/$pkgname/doc

pkgmk -o -r $pkgtmpdir/opt -d $pkgtmpdir -f $pkgtmpdir/proto
pkgtrans -s $pkgtmpdir $pkgtmpdir/$pkgname.pkg $pkgname
bzip2 $pkgtmpdir/$pkgname.pkg
cp $pkgtmpdir/$pkgname.pkg.bz2 . 

exit 0
