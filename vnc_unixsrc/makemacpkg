#!/bin/sh

pkgtmpdir=

doexit()
{
	if [ ! "$pkgtmpdir" = "" ]; then
		sudo rm -rf $pkgtmpdir
	fi
	exit $1
}

if [ "$1" = "clean" ]; then
xmkmf || doexit -1
make clean || doexit -1
exit 0
fi

xmkmf || doexit -1
make World || doexit -1

pkgtmpdir=`mktemp -d /tmp/vncbuild.XXXXXX`
pkgname=TurboVNC
_VERSION=`cat TurboVNC-version`
_BUILD=`date +%Y%m%d`
PACKAGEMAKER=/Developer/Applications/Utilities/PackageMaker.app/Contents/MacOS/PackageMaker

if [ -f $pkgname-$_VERSION.dmg ]; then rm -f $pkgname-$_VERSION.dmg; fi
mkdir -p $pkgtmpdir/pkg/Package_Root/opt/$pkgname/bin || doexit -1
mkdir -p $pkgtmpdir/pkg/Package_Root/opt/$pkgname/lib || doexit -1
mkdir -p $pkgtmpdir/pkg/Package_Root/opt/$pkgname/man/man1 || doexit -1
mkdir -p $pkgtmpdir/pkg/Package_Root/Applications/$pkgname || doexit -1
mkdir -p $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
chmod 1775 $pkgtmpdir/pkg/Package_Root/Library || doexit -1
mkdir -p $pkgtmpdir/pkg/Resources || doexit -1
(cat Description.plist.tmpl | sed s/{__VERSION}/$_VERSION/g > $pkgtmpdir/pkg/Description.plist) || doexit -1
(cat Info.plist.tmpl | sed s/{__VERSION}/$_VERSION/g  | sed s/{__BUILD}/$_BUILD/g > $pkgtmpdir/pkg/Info.plist) || doexit -1
install -m 755 vncviewer/vncviewer $pkgtmpdir/pkg/Package_Root/opt/$pkgname/bin || doexit -1
install -m 755 /usr/lib/libturbojpeg-ipp.dylib $pkgtmpdir/pkg/Package_Root/opt/$pkgname/lib/libturbojpeg.dylib || doexit -1
install -m 755 /usr/lib/libturbojpeg-ipp.dylib $pkgtmpdir/pkg/Package_Root/opt/$pkgname/lib || doexit -1
install -m 755 /usr/lib/libturbojpeg-libjpeg.dylib $pkgtmpdir/pkg/Package_Root/opt/$pkgname/lib || doexit -1
install -m 755 /usr/bin/switchtjpeg $pkgtmpdir/pkg/Package_Root/opt/$pkgname/bin || doexit -1
install -m 755 uninstall.sh $pkgtmpdir/pkg/Package_Root/opt/$pkgname/bin/uninstall || doexit -1
install_name_tool -change libturbojpeg.dylib /opt/$pkgname/lib/libturbojpeg.dylib $pkgtmpdir/pkg/Package_Root/opt/$pkgname/bin/vncviewer || doexit -1
install -m 755 vncviewer/vncviewer.man $pkgtmpdir/pkg/Package_Root/opt/$pkgname/man/man1 || doexit -1
install -m 644 ReadMe-MacApp.txt "$pkgtmpdir/pkg/Package_Root/Applications/$pkgname/Read Me.txt" || doexit -1
install -m 644 LICENCE.TXT $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
install -m 644 WhatsNew $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
install -m 644 ChangeLog $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
install -m 644 TurboVNC-ChangeLog.txt $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
install -m 644 TurboVNC-CompatibilityGuide.txt $pkgtmpdir/pkg/Package_Root/Library/Documentation/$pkgname || doexit -1
sudo chown -R root:admin $pkgtmpdir/pkg/Package_Root || doexit -1
cp License.rtf Welcome.rtf ReadMe.rtf $pkgtmpdir/pkg/Resources/ || doexit -1
mkdir $pkgtmpdir/dmg
$PACKAGEMAKER -build -v -p $pkgtmpdir/dmg/$pkgname.pkg \
	-f $pkgtmpdir/pkg/Package_Root -r $pkgtmpdir/pkg/Resources \
  -i $pkgtmpdir/pkg/Info.plist -d $pkgtmpdir/pkg/Description.plist || doexit -1
install -m 644 vncuninstall.applescript $pkgtmpdir || doexit -1
sudo osacompile -t APPL -o "$pkgtmpdir/dmg/Uninstall $pkgname.app" $pkgtmpdir/vncuninstall.applescript || doexit -1
sudo chown -R $USER "$pkgtmpdir/dmg/Uninstall $pkgname.app" || doexit -1
hdiutil create -fs HFS+ -volname $pkgname-$_VERSION \
	-srcfolder $pkgtmpdir/dmg \
	$pkgtmpdir/$pkgname.dmg || doexit -1
cp $pkgtmpdir/$pkgname.dmg . || doexit -1
doexit 0
