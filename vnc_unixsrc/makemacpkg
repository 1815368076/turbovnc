#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

pkgtmpdir=

onexit()
{
	if [ ! "$pkgtmpdir" = "" ]; then
		sudo rm -rf $pkgtmpdir
	fi
}

UNIVERSAL=0
if [ $# -gt 0 ]; then
	if [ "$1" = "universal" ]; then UNIVERSAL=1; fi
fi

pkgname=TurboVNC
pkgtmpdir=`mktemp -d /tmp/$pkgname-build.XXXXXX`
PKGROOT=$pkgtmpdir/pkg/Package_Root
_VERSION=`cat TurboVNC-version`
_BUILD=`date +%Y%m%d`
PACKAGEMAKER=/Developer/Applications/Utilities/PackageMaker.app/Contents/MacOS/PackageMaker

if [ -f $pkgname-$_VERSION.dmg ]; then rm -f $pkgname-$_VERSION.dmg; fi

mkdir -p $PKGROOT/opt/$pkgname/bin
mkdir -p $PKGROOT/opt/$pkgname/lib
mkdir -p $PKGROOT/opt/$pkgname/man/man1
mkdir -p $PKGROOT/Applications/$pkgname
mkdir -p $PKGROOT/Library/Documentation/$pkgname
chmod 1775 $PKGROOT/Library
mkdir -p $pkgtmpdir/pkg/Resources

xmkmf
if [ $UNIVERSAL ]; then
	make Makefiles
	make clean
	make World CDEBUGFLAGS='-O3' \
		EXTRA_DEFINES="-m32 -D__i386__ -U__amd64__ \
			-isysroot /Developer/SDKs/MacOSX10.4u.sdk \
    	-mmacosx-version-min=10.4" \
		EXTRA_LDOPTIONS="-m32 -L/usr/X11R6/lib -L/usr/lib \
			-isysroot /Developer/SDKs/MacOSX10.4u.sdk \
    	-mmacosx-version-min=10.4"
	install -m 755 vncviewer/vncviewer $pkgtmpdir/vncviewer.32
fi
make Makefiles
make clean
make World CDEBUGFLAGS='-O3'

(cat Description.plist.tmpl | sed s/{__VERSION}/$_VERSION/g > $pkgtmpdir/pkg/Description.plist)
(cat Info.plist.tmpl | sed s/{__VERSION}/$_VERSION/g  | sed s/{__BUILD}/$_BUILD/g > $pkgtmpdir/pkg/Info.plist)
install -m 755 vncviewer/vncviewer $PKGROOT/opt/$pkgname/bin 
install -m 755 uninstall.sh $PKGROOT/opt/$pkgname/bin/uninstall 
install -m 755 vncviewer/vncviewer.man $PKGROOT/opt/$pkgname/man/man1 
install -m 644 ReadMe-MacApp.txt "$PKGROOT/Applications/$pkgname/Read Me.txt" 
install -m 644 LICENCE.TXT $PKGROOT/Library/Documentation/$pkgname 
install -m 644 WhatsNew $PKGROOT/Library/Documentation/$pkgname 
install -m 644 ChangeLog $PKGROOT/Library/Documentation/$pkgname 
install -m 644 TurboVNC-ChangeLog.txt $PKGROOT/Library/Documentation/$pkgname 
install -m 644 ../vnc_docs/LICEN*.txt ../vnc_docs/*.html ../vnc_docs/*.png ../vnc_docs/*.css $PKGROOT/Library/Documentation/$pkgname 
sudo ln -fs /Library/Documentation/$pkgname/index.html "$PKGROOT/Applications/$pkgname/User's Guide.html"

if [ $UNIVERSAL ]; then
	lipo -create -arch i386 $pkgtmpdir/vncviewer.32 \
		-arch x86_64 $PKGROOT/opt/$pkgname/bin/vncviewer \
		-output $PKGROOT/opt/$pkgname/bin/vncviewer
fi

sudo chown -R root:admin $PKGROOT 
cp License.rtf Welcome.rtf ReadMe.rtf $pkgtmpdir/pkg/Resources/ 
mkdir $pkgtmpdir/dmg
$PACKAGEMAKER -build -v -p $pkgtmpdir/dmg/$pkgname.pkg \
	-f $PKGROOT -r $pkgtmpdir/pkg/Resources \
  -i $pkgtmpdir/pkg/Info.plist -d $pkgtmpdir/pkg/Description.plist 
install -m 644 vncuninstall.applescript $pkgtmpdir 
sudo osacompile -t APPL -o "$pkgtmpdir/dmg/Uninstall $pkgname.app" $pkgtmpdir/vncuninstall.applescript 
sudo chown -R $USER "$pkgtmpdir/dmg/Uninstall $pkgname.app" 
hdiutil create -fs HFS+ -volname $pkgname-$_VERSION \
	-srcfolder $pkgtmpdir/dmg $pkgtmpdir/$pkgname.dmg 
cp $pkgtmpdir/$pkgname.dmg .

exit 0
