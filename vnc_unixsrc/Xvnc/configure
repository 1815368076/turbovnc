#!/bin/sh
# configure
#
# This script sets up for a build.  It has been tested on the following
# Operating System versions (uname outputs):
#
#    Solaris 10 (SunOS 5.10)
#    Linux 2.4 and 2.6

M32=0
FORCEGCC=0
FORCEX86=0
FORCEX86_64=0
JPEGINC=
JPEGLINK=

while [ $# -gt 0 ]; do
    case "$1" in
        -gcc)  FORCEGCC=1  ;;
        -x86)  FORCEX86=1  ;;
        -x86_64)  FORCEX86_64=1  ;;
        -jpeginc)  JPEGINC=$2;  shift  ;;
        -jpeglink)  JPEGLINK=$2;  shift  ;;
        *)  break  ;;
    esac
    shift
done


SYSNAME=`uname -s`

if [ "$SYSNAME" = AIX ]
then
    MAJOR=`uname -v`
    MINOR=`uname -r`
    TEENY=0
else
    REV=`uname -r`

    if [ "$SYSNAME" = HP-UX ]
    then
        REV=`echo $REV | sed -e 's/^[^.]*\.//'`
    else
        if [ "$SYSNAME" != Darwin ]
        then
            REV=`echo $REV | sed -e 's/^V//' -e 's/-.*$//'`
        fi
    fi

    MAJOR=`echo $REV | awk -F. 'NF < 1 {print "0"} {print $1}'`
    MINOR=`echo $REV | awk -F. 'NF < 2 {print "0"} {print $2}'`
    TEENY=`echo $REV | awk -F. 'NF < 3 {print "0"} {print $3}'`
fi

echo "#define OSName $SYSNAME" > config/cf/platform.def
echo "#define OSMajorVersion $MAJOR" >> config/cf/platform.def
echo "#define OSMinorVersion $MINOR" >> config/cf/platform.def
echo "#define OSTeenyVersion $TEENY" >> config/cf/platform.def
echo "#define LinuxCLibMajorVersion 6" >> config/cf/platform.def
if [ $FORCEGCC = 1 ]; then
    echo "#define HasGcc2 YES" >> config/cf/platform.def
fi
if [ $FORCEX86 = 1 ]; then
    echo "#define i386Architecture" >> config/cf/platform.def
    echo "#undef x86_64Architecture" >> config/cf/platform.def
fi
if [ $FORCEX86_64 = 1 ]; then
    echo "#define x86_64Architecture" >> config/cf/platform.def
fi
if [ ! "$JPEGINC" = "" ]; then
    echo "#define JPEGIncludeFlags $JPEGINC" >>config/cf/platform.def
fi
if [ ! "$JPEGLINK" = "" ]; then
    echo "#define JPEGLibraryFlags $JPEGLINK" >>config/cf/platform.def
fi

if [ "$SYSNAME" = AIX ]
then
#  xmkmf and imake are broken on AIX
    cd config/imake
    imake -I../cf -DTOPDIR=../.. -DCURDIR=.
    make Makefiles
    make includes
    make depend
    make
    cd ../..
    imake -I./config/cf -DTOPDIR=./ -DCURDIR=.
    make Makefiles
    make includes
    make depend
else
    cd config/imake
    xmkmf ../../
    make ${1+"$@"}
    cd ../..
    cd config/makedepend
    xmkmf ../../
    make ${1+"$@"}
    cd ../..
    cd config/util
    xmkmf ../../
    make ${1+"$@"}
    cd ../..
    config/imake/imake -I./config/cf -DTOPDIR=./ -DCURDIR=.
    make Makefiles ${1+"$@"}
    make includes ${1+"$@"}
    make depend ${1+"$@"}
fi

exit 0
