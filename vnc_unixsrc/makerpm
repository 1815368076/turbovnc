#!/bin/bash

RPMARCH=i386
M32=0
CLEAN=0

while [ $# -gt 0 ]; do
	case "$1" in
	-m32) M32=1;;
	clean) CLEAN=1;;
	*) break;;
	esac
	shift
done

MAKEARGS=${1+"$@"}

if [ `uname -m` = 'x86_64' ]; then
	if [ $M32 = 0 ]; then
		RPMARCH=`uname -m`
	fi
else
	if [ $M32 = 1 ]; then
		M32=0
	fi
fi

if [ $CLEAN = 1 ]; then
xmkmf || exit -1
make Makefiles || exit -1
make clean || exit -1
cd Xvnc
if [ ! -f Makefile ]; then
	if [ $M32 = 1 ]; then
		sh ./configure -m32 || exit -1
	else
		sh ./configure || exit -1
	fi
fi
make clean || exit -1
cd ..
exit
fi

if [ $M32 = 1 ]; then
	if [ "$MAKEARGS" = "" ]; then
		sh make32 || exit -1
	else
		sh make32 "$MAKEARGS" || exit -1
	fi
else
	xmkmf || exit -1
	if [ "$MAKEARGS" = "" ]; then
		make World || exit -1
	else
		make "$MAKEARGS" World || exit -1
	fi
fi
cd Xvnc
if [ $M32 = 1 ]; then
	sh ./configure -m32 || exit -1
else
	sh ./configure || exit -1
fi
if [ "$MAKEARGS" = "" ]; then
	make || exit -1
else
	make "$MAKEARGS" || exit -1
fi
cd ..

umask 077
TMPDIR=`mktemp -d /tmp/vncbuild.XXXXXX`
mkdir -p $TMPDIR/rpms/RPMS
ln -fs `pwd` $TMPDIR/rpms/BUILD

BUILD=`date +%Y%m%d`
VERSION=`cat TurboVNC-version`
rpmbuild -bb --buildroot $TMPDIR/rpms/TurboVNC-buildroot --define "_topdir $TMPDIR/rpms" \
	--define "_bindir /opt/TurboVNC/bin" --define "_mandir /opt/TurboVNC/man" \
	--define "_datadir /opt/TurboVNC" --define "_version $VERSION" \
	--define "_build $BUILD" \
	--target $RPMARCH turbovnc.spec

mv $TMPDIR/rpms/RPMS/$RPMARCH/turbovnc-$VERSION-$BUILD.$RPMARCH.rpm turbovnc.$RPMARCH.rpm

rm -rf $TMPDIR
