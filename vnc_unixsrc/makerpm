#!/bin/bash

if [ "$1" = "clean" ]; then
xmkmf || exit -1
make clean || exit -1
cd Xvnc
./configure || exit -1
make clean || exit -1
./configure || exit -1
cd ..
if [ ! -f ../../vgl/Makefile ]; then
	echo Could not find VirtualGL build directory at ../../vgl !
	exit -1
else
	__PWD=`pwd`
	cd ../../vgl
	make DISTRO=vnc clean
	cd $__PWD
fi
fi

make World || exit -1
cd Xvnc
make || exit -1
cd ..

if [ ! -f ../../vgl/Makefile ]; then
	echo Could not find VirtualGL build directory at ../../vgl !
	exit -1
else
	__PWD=`pwd`
	cd ../../vgl
	make DISTRO=vnc jpeg
	make DISTRO=vnc jpeg
	cd $__PWD
fi

rm -rf rpms/
mkdir -p rpms/RPMS
cd rpms; ln -fs .. BUILD; cd ..

BUILD=`date +%Y%m%d`
rpmbuild -bb --buildroot `pwd`/rpms/TurboVNC-buildroot --define "_topdir `pwd`/rpms" \
	--define "_bindir /opt/TurboVNC/bin" --define "_mandir /opt/TurboVNC/man" \
	--define "_datadir /opt/TurboVNC" --define "_libdir /opt/TurboVNC/lib" \
	--define "_build $BUILD" --define "_srclibdir ../../vgl/linux/vnc/lib" turbovnc.spec

RPMTAG=glibc`rpm -q glibc | cut -f2 -d- | cut -f1,2 -d. | sed s/\\\.//g`
for i in rpms/RPMS/i386/turbovnc*.rpm; do
	mv $i `basename $i | sed s@$BUILD@$RPMTAG@g`
done

rm -rf rpms/
