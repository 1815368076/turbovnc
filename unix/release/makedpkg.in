#!/bin/sh

set -u
set -e
trap onexit INT
trap onexit TERM
trap onexit EXIT

TMPDIR=

onexit()
{
	if [ ! "$TMPDIR" = "" ]; then
		sudo rm -rf $TMPDIR
	fi
}

PACKAGE_NAME=@PACKAGE_NAME@
VERSION=@VERSION@
BUILD=@BUILD@
DEBARCH=@PKGARCH@
SRCDIR=@abs_top_srcdir@
PREFIX=@prefix@

umask 022
rm -f $PACKAGE_NAME\_$DEBARCH.deb
TMPDIR=`mktemp -d /tmp/$PACKAGE_NAME-build.XXXXXX`
mkdir $TMPDIR/DEBIAN
cp pkgscripts/deb-control $TMPDIR/DEBIAN/control

make install DESTDIR=$TMPDIR sysconfdir=/etc
make xserver-install DESTDIR=$TMPDIR sysconfdir=/etc

mkdir -p $TMPDIR/etc/init.d
cat $SRCDIR/vncserver.init | sed -e 's@vncserver :${display\%\%:@$PREFIX/bin/vncserver :${display\%\%:@g' | sed -e 's@vncserver -kill :${display\%\%:@$PREFIX/bin/vncserver -kill :${display\%\%:@g' > $TMPDIR/etc/init.d/tvncserver
chmod 755 $TMPDIR/etc/init.d/tvncserver

mkdir -p $TMPDIR/etc/sysconfig
install -m 644 $SRCDIR/tvncservers $TMPDIR/etc/sysconfig/tvncservers

mkdir -p $TMPDIR/usr/share/applications
cat > $TMPDIR/usr/share/applications/tvncviewer.desktop <<EOF
[Desktop Entry]
Name=TurboVNC Viewer
Comment=TurboVNC client application
Exec=$PREFIX/bin/vncviewer
Terminal=0
Type=Application
Categories=Application;Utility;X-Red-Hat-Extra;
EOF

mkdir -p $TMPDIR/usr/share/doc/$PACKAGE_NAME-$VERSION
install -m 644 $SRCDIR/../ChangeLog.txt $TMPDIR/usr/share/doc/$PACKAGE_NAME-$VERSION
install -m 644 $SRCDIR/../doc/LICEN*.txt $SRCDIR/../doc/*.html $SRCDIR/../doc/*.png $SRCDIR/../doc/*.css $TMPDIR/usr/share/doc/$PACKAGE_NAME-$VERSION

sudo chown -Rh root:root $TMPDIR/*
dpkg -b $TMPDIR $PACKAGE_NAME\_$VERSION\_$DEBARCH.deb

exit
